<!DOCTYPE html>
<html lang="no" style="display: table; margin: auto;">
<head>
    <meta charset="UTF-8" content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Task 5.2</title>
    <style>
        body {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            display: table-cell;
            vertical-align: middle;
            text-align: center;
        }
    </style>
    <script src="../Sound/tone.js"></script>
    <script src="../Sprite/Sprite.js"></script>
</head>
<body>
<h2><label for="cvs">Simon Says</label></h2>
<canvas id="cvs" height="100px" width="100px" style="background-color: antiquewhite"></canvas>
<h4>Press F12 to debug (Chrome and Firefox)</h4>
<p id="message" style="color:black; font-weight: normal; font-size: 25px; text-align: left"></p>
<script>
    "use strict";
    //--------------------------------------------------------------------------------------------------------------------
    //------ Variables, Constants and Objects
    //--------------------------------------------------------------------------------------------------------------------
    const SimonSaysSheet = {
        Background: {x: 0, y: 0, w: 720, h: 720, count: 2, speed: 0, alpha: 1},
        ButtonYellow: {
            x: 0,
            y: 720,
            w: 314,
            h: 314,
            count: 2,
            speed: 0,
            alpha: 1,
            pos: {x: 29, y: 377, r1: 100, r2: 333}
        },
        ButtonBlue: {
            x: 0,
            y: 1034,
            w: 314,
            h: 314,
            count: 2,
            speed: 0,
            alpha: 1,
            pos: {x: 377, y: 377, r1: 100, r2: 333}
        },
        ButtonRed: {
            x: 0,
            y: 1348,
            w: 314,
            h: 314,
            count: 2,
            speed: 0,
            alpha: 1,
            pos: {x: 377, y: 29, r1: 100, r2: 333}
        },
        ButtonGreen: {
            x: 0,
            y: 1662,
            w: 314,
            h: 314,
            count: 2,
            speed: 0,
            alpha: 1,
            pos: {x: 29, y: 29, r1: 100, r2: 333}
        },
        ButtonStartEnd: {
            x: 0,
            y: 1976,
            w: 360,
            h: 360,
            count: 2,
            speed: 0,
            alpha: 1,
            pos: {x: 180, y: 180, r1: 1, r2: 180}
        }
    };

    const Position = {x: 0, y: 0};
    const centerGame = {x: SimonSaysSheet.Background.w / 2, y: SimonSaysSheet.Background.h / 2};
    const cvs = document.getElementById("cvs");
    const ctx = cvs.getContext("2d");
    const imgSheet = new Image();
    const mousePos = Object.create(Position);

    let color = "";
    let red = false;
    let yellow = false;
    let blue = false;
    let green = false;
    let count = 0;

    //--------------------------------------------------------------------------------------------------------------------
    //------ Classes
    //--------------------------------------------------------------------------------------------------------------------

    const Background = {sprite: null, pos: null};

    const EGameStatus = {start: 1, running: 2, computer: 3, gameOver: 4};
    let gameStatus = EGameStatus.start;

    function TBackground() {
        const pos = Object.create(Position);
        pos.x = SimonSaysSheet.Background.x;
        pos.y = SimonSaysSheet.Background.y;
        const sprite = new TSprite(imgSheet, SimonSaysSheet.Background, pos);

        this.draw = function () {
            sprite.draw()
        }
    }

    let button;

    function TButtons() {
        button = Object.create(Position);

        //yellow
        button.x = SimonSaysSheet.ButtonYellow.pos.x;
        button.y = SimonSaysSheet.ButtonYellow.pos.y;
        const sprite1 = new TSprite(imgSheet, SimonSaysSheet.ButtonYellow, button, 0);
        sprite1.draw();

        //blue
        button.x = SimonSaysSheet.ButtonBlue.pos.x;
        button.y = SimonSaysSheet.ButtonBlue.pos.y;
        const sprite2 = new TSprite(imgSheet, SimonSaysSheet.ButtonBlue, button, 0);
        sprite2.draw();

        //red
        button.x = SimonSaysSheet.ButtonRed.pos.x;
        button.y = SimonSaysSheet.ButtonRed.pos.y;
        const sprite3 = new TSprite(imgSheet, SimonSaysSheet.ButtonRed, button, 0);
        sprite3.draw();

        //green
        button.x = SimonSaysSheet.ButtonGreen.pos.x;
        button.y = SimonSaysSheet.ButtonGreen.pos.y;
        const sprite4 = new TSprite(imgSheet, SimonSaysSheet.ButtonGreen, button, 0);
        sprite4.draw();
    }


    //--------------------------------------------------------------------------------------------------------------------
    //------ Function and Events
    //--------------------------------------------------------------------------------------------------------------------
    /* function isMouseInsideButton(aBounds, r1, r2) {
         let isOver = !((mousePos.x < aBounds.left) || (mousePos.y < aBounds.top) || (mousePos.x > aBounds.right) || (mousePos.y > aBounds.bottom));
         if (isOver) {
             const hyp = Math.pow(mousePos.x - centerGame.x, 2) + Math.pow(mousePos.y - centerGame.y, 2);
             isOver = (hyp > r1) && (hyp < r2);
         }
         return isOver;
     }

     function setMousePos(aEvent) {
         const bounds = cvs.getBoundingClientRect();
         mousePos.x = aEvent.clientX - bounds.left;
         mousePos.y = aEvent.clientY - bounds.top;
     }

     function cvsMouseMove(aEvent) {
         setMousePos(aEvent);
     }*/
    let loopCount = 0;
    let score = 0;
    let randomNumber = 0;
    let allRandomNumbers = [];
    const allColors = [SimonSaysSheet.ButtonGreen, SimonSaysSheet.ButtonBlue, SimonSaysSheet.ButtonRed, SimonSaysSheet.ButtonYellow];

    function computer() {
        randomNumber = Math.floor(Math.random() * 3);
        allRandomNumbers.push(randomNumber);
        window.setTimeout(computerPlay, 1000);
    }

    function computerPlay() {
        button.x = allColors[allRandomNumbers[loopCount]].pos.x;
        button.y = allColors[allRandomNumbers[loopCount]].pos.y;

        const sprite = new TSprite(imgSheet, allColors[allRandomNumbers[loopCount]], button, 1);
        sprite.draw();
        window.setTimeout(computerStop, 1000);
    }

    function computerStop() {
        if (loopCount < allRandomNumbers.length - 1) {
            window.setTimeout(computerPlay, 500);
            button.x = allColors[allRandomNumbers[loopCount]].pos.x;
            button.y = allColors[allRandomNumbers[loopCount]].pos.y;
            const sprite = new TSprite(imgSheet, allColors[allRandomNumbers[loopCount]], button, 0);
            sprite.draw();
            loopCount++;
        } else {
            score++;
            button.x = allColors[randomNumber].pos.x;
            button.y = allColors[randomNumber].pos.y;
            const sprite = new TSprite(imgSheet, allColors[randomNumber], button, 0);
            sprite.draw();
            gameStatus = EGameStatus.running;
            message.innerText = "score: "+score+ ", loop: " + loopCount + ", allRandomNumbers.length; "+(allRandomNumbers.length-1);
        }
    }

    function userPlay() {
        if (count === allRandomNumbers.length) {
            computer();
            count = 0;
        } else {
            count++;
            console.log(count);
        }
    }


    function cvsMouseDown(event) {
        // Mouse button down in canvas
        const cx = event.pageX;
        const cy = event.pageY;
        // console.log("x=" + cx);
        // console.log("y=" + cy);
        if (gameStatus === EGameStatus.start) {
            if ((cy > 250 && cy < 600) && (cx < 1140 && cx > 780)) {
                gameRunning();
            }
        }
        if (gameStatus === EGameStatus.running) {
            if ((cy > 95 && cy < 410) && (cx < 1290 && cx > 975)) {
                color = SimonSaysSheet.ButtonRed;
                if (allRandomNumbers[count] != allColors.indexOf(SimonSaysSheet.ButtonRed)) {
                    gameOver();
                } else {
                    onClick();
                    userPlay();
                }
            } else if ((cy > 95 && cy < 410) && (cx > 630 && cx < 940)) {
                color = SimonSaysSheet.ButtonGreen;
                if (allRandomNumbers[count] != allColors.indexOf(SimonSaysSheet.ButtonGreen)) {
                    window.setTimeout(gameOver, 500)
                } else {
                    onClick();
                    userPlay();
                }
            } else if ((cy > 440 && cy < 760) && (cx > 630 && cx < 940)) {
                color = SimonSaysSheet.ButtonYellow;
                if (allRandomNumbers[count] != allColors.indexOf(SimonSaysSheet.ButtonYellow)) {
                    window.setTimeout(gameOver, 500)
                } else {
                    onClick();
                    userPlay();
                }
            } else if ((cy > 440 && cy < 760) && (cx < 1290 && cx > 975)) {
                color = SimonSaysSheet.ButtonBlue;
                if (allRandomNumbers[count] != allColors.indexOf(SimonSaysSheet.ButtonBlue)) {
                    window.setTimeout(gameOver, 500)
                } else {
                    onClick();
                    count++;
                    userPlay();
                }
            }
        }
    }


    function onClick() {
        button = Object.create(Position);
        button.x = color.pos.x;
        button.y = color.pos.y;
        const sprite = new TSprite(imgSheet, color, button, 1);
        sprite.draw();
    }

    function cvsMouseUp() {
        button = Object.create(Position);
        button.x = color.pos.x;
        button.y = color.pos.y;
        const sprite = new TSprite(imgSheet, color, button, 0);
        sprite.draw();
        gameStatus = EGameStatus.running;
    }

    function loadGame() {
        Background.pos = Object.create(Position);
        Background.sprite = new TSprite(imgSheet, SimonSaysSheet.Background, Background.pos);
        drawGame();
        startGame();
    }

    function drawGame() {
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        Background.sprite.draw();
        button = new TButtons()
    }

    const midBTN = Object.create(Position);

    function startGame() {
        midBTN.x = SimonSaysSheet.ButtonStartEnd.pos.x;
        midBTN.y = SimonSaysSheet.ButtonStartEnd.pos.y;
        if (gameStatus != EGameStatus.computer) {
            const sprite = new TSprite(imgSheet, SimonSaysSheet.ButtonStartEnd, midBTN, 0);
            sprite.draw();
        }
    }

    function gameRunning() {
        //vil ikke funke å trykke på knapper med en gang med denne aktivert.
        gameStatus = EGameStatus.computer;
        loadGame();
        window.setTimeout(computer, 2000);
    }

    function gameOver() {
        midBTN.x = SimonSaysSheet.ButtonStartEnd.pos.x;
        midBTN.y = SimonSaysSheet.ButtonStartEnd.pos.y;
        const sprite = new TSprite(imgSheet, SimonSaysSheet.ButtonStartEnd, midBTN, 1);
        sprite.draw();
        gameStatus = EGameStatus.gameOver;
    }

    //--------------------------------------------------------------------------------------------------------------------
    //------ Main Code
    //--------------------------------------------------------------------------------------------------------------------
    imgSheet.addEventListener("load", loadGame);
    imgSheet.src = "SimonSaysSheet.png";
    cvs.width = SimonSaysSheet.Background.w;
    cvs.height = SimonSaysSheet.Background.h;
    /*   cvs.addEventListener("mousemove", cvsMouseMove);*/
    cvs.addEventListener("mousedown", cvsMouseDown);
    cvs.addEventListener("mouseup", cvsMouseUp);
    document.addEventListener('contextmenu', aEvent => aEvent.preventDefault());

</script>

</body>
</html>